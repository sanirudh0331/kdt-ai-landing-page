<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KdT AI - Your AI Toolkit for Venture</title>
    <meta name="description" content="AI-powered tools for venture capital research - portfolio tracking, talent scouting, conference planning, and more.">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="static/kdt-logo.png">

    <!-- Open Graph / Social -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kdt-ai-landing-page-production.up.railway.app/">
    <meta property="og:title" content="KdT AI - Your AI Toolkit for Venture">
    <meta property="og:description" content="AI-powered tools for venture capital research - portfolio tracking, talent scouting, conference planning, and more.">
    <meta property="og:image" content="https://kdt-ai-landing-page-production.up.railway.app/static/kdt-logo.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="KdT AI - Your AI Toolkit for Venture">
    <meta name="twitter:description" content="AI-powered tools for venture capital research - portfolio tracking, talent scouting, conference planning, and more.">

    <!-- Preconnect to external services for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Railway apps - preconnect for TCP/TLS handshake -->
    <link rel="preconnect" href="https://grants-tracker-production.up.railway.app">
    <link rel="preconnect" href="https://kdttalentscout.up.railway.app">
    <link rel="preconnect" href="https://web-production-a9d068.up.railway.app">
    <link rel="preconnect" href="https://kdt.up.railway.app">
    <link rel="preconnect" href="https://policywatch.up.railway.app">
    <link rel="dns-prefetch" href="https://grants-tracker-production.up.railway.app">
    <link rel="dns-prefetch" href="https://kdttalentscout.up.railway.app">
    <link rel="dns-prefetch" href="https://web-production-a9d068.up.railway.app">
    <link rel="dns-prefetch" href="https://kdt.up.railway.app">
    <link rel="dns-prefetch" href="https://policywatch.up.railway.app">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Prevent flash of wrong theme
        (function() {
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (saved === 'dark' || (!saved && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        dark: {
                            950: '#09090b',
                            900: '#18181b',
                            800: '#27272a',
                            700: '#3f3f46',
                            500: '#71717a',
                            400: '#a1a1aa',
                            200: '#e4e4e7',
                            100: '#f4f4f5',
                            50: '#fafafa'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        * { transition: background-color 200ms, border-color 200ms, color 200ms; }

        /* Background effects */
        .bg-glow {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: -1;
        }

        /* Radial glow - dark mode */
        .dark .bg-glow::before {
            content: '';
            position: absolute;
            top: -20%;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 60%;
            background: radial-gradient(ellipse at center, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.08) 40%, transparent 70%);
            filter: blur(60px);
        }

        /* Radial glow - light mode */
        .bg-glow::before {
            content: '';
            position: absolute;
            top: -20%;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 60%;
            background: radial-gradient(ellipse at center, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.04) 40%, transparent 70%);
            filter: blur(60px);
        }

        /* Noise texture overlay */
        .bg-glow::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.03;
        }

        .dark .bg-glow::after {
            opacity: 0.04;
        }

        /* Animated gradient background */
        .hero-gradient {
            background: linear-gradient(-45deg, #6366f1, #8b5cf6, #a855f7, #6366f1);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Chat bubble styles with animations */
        @keyframes chatSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .chat-bubble-user, .chat-bubble-neo {
            animation: chatSlideIn 0.3s ease-out;
        }
        .chat-bubble-user {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            border-radius: 1rem 1rem 0.25rem 1rem;
            max-width: 80%;
            margin-left: auto;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
        }
        .chat-bubble-neo {
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 1rem 1rem 1rem 0.25rem;
            max-width: 85%;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }
        .dark .chat-bubble-neo {
            background: rgba(99, 102, 241, 0.12);
            border-color: rgba(99, 102, 241, 0.25);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        }
        /* Thinking state with glow pulse */
        .chat-bubble-neo.thinking {
            animation: chatSlideIn 0.3s ease-out, glowPulse 2s infinite ease-in-out;
        }
        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 1px 4px rgba(99, 102, 241, 0.1); }
            50% { box-shadow: 0 4px 20px rgba(99, 102, 241, 0.35); }
        }
        /* Typing indicator with smooth pulse */
        .typing-indicator {
            padding: 2px 0;
        }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 50%;
            margin: 0 3px;
            animation: dotPulse 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes dotPulse {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.1);
                opacity: 1;
            }
        }
        /* Neo thinking logo and text */
        .neo-thinking-logo {
            animation: logoPulse 1.5s infinite ease-in-out;
        }
        @keyframes logoPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }
        .neo-thinking-text {
            color: #6366f1;
            animation: textFade 2s infinite ease-in-out;
        }
        .dark .neo-thinking-text {
            color: #818cf8;
        }
        @keyframes textFade {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* Floating particles */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            opacity: 0.3;
            animation: float 15s infinite ease-in-out;
        }

        .dark .particle {
            background: rgba(139, 92, 246, 0.5);
        }

        .particle {
            background: rgba(99, 102, 241, 0.4);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            50% { transform: translateY(-100px) translateX(20px); }
        }

        /* Glow effect on cards */
        .card-glow:hover {
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.15);
        }

        .dark .card-glow:hover {
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.2);
        }

        /* Crisp logo rendering */
        .tool-logo {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        /* Icon hover animation */
        .icon-container {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .group:hover .icon-container {
            transform: scale(1.1);
        }

        /* News ticker */
        .ticker-wrapper {
            overflow: hidden;
            white-space: nowrap;
        }
        .ticker-content {
            display: inline-block;
            animation: ticker 60s linear infinite;
        }
        .ticker-content:hover {
            animation-play-state: paused;
        }
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        .dark .skeleton {
            background: linear-gradient(90deg, #27272a 25%, #3f3f46 50%, #27272a 75%);
            background-size: 200% 100%;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Twitter embed container */
        .twitter-timeline-container {
            max-height: 450px;
            overflow-y: auto;
        }
        .twitter-timeline-container::-webkit-scrollbar {
            width: 6px;
        }
        .twitter-timeline-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .twitter-timeline-container::-webkit-scrollbar-thumb {
            background: #71717a;
            border-radius: 3px;
        }
        .dark .twitter-timeline-container::-webkit-scrollbar-thumb {
            background: #3f3f46;
        }

        /* Card load animation */
        .card-animate {
            animation: cardFadeIn 0.4s ease-out forwards;
            opacity: 0;
        }
        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Staggered animation delays */
        .card-animate:nth-child(1) { animation-delay: 0.05s; }
        .card-animate:nth-child(2) { animation-delay: 0.1s; }
        .card-animate:nth-child(3) { animation-delay: 0.15s; }
        .card-animate:nth-child(4) { animation-delay: 0.2s; }
        .card-animate:nth-child(5) { animation-delay: 0.25s; }
        .card-animate:nth-child(6) { animation-delay: 0.3s; }
        .card-animate:nth-child(7) { animation-delay: 0.35s; }

        /* Ticker pause on tap/hover */
        .ticker-paused .ticker-content {
            animation-play-state: paused;
        }

        /* Login transition */
        #login-gate {
            transition: opacity 0.35s ease;
        }
        #login-gate.fade-out {
            opacity: 0;
        }
        .transition-overlay {
            position: fixed;
            inset: 0;
            background: #09090b;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .dark .transition-overlay {
            background: #09090b;
        }
        .transition-overlay:not(.dark) {
            background: #fafafa;
        }
        .transition-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .transition-logo {
            width: 64px;
            height: 64px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .transition-logo.visible {
            opacity: 1;
        }
        /* Scrolling text for overflow content */
        .scroll-container {
            mask-image: linear-gradient(to right, black 90%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 90%, transparent 100%);
        }
        .scroll-container:hover .scroll-text.scrollable {
            animation: scroll-text 8s linear infinite;
        }
        @keyframes scroll-text {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* Mobile menu animation */
        #mobileMenu {
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Hide scrollbar for filter tabs on mobile */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .overflow-x-auto::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="bg-dark-50 dark:bg-dark-950 text-dark-900 dark:text-dark-50 min-h-screen antialiased">
    <!-- Background glow effect -->
    <div class="bg-glow"></div>

    <!-- Login Gate -->
    <div id="login-gate" class="fixed inset-0 z-[100] bg-dark-50 dark:bg-dark-950 flex items-center justify-center px-4">
        <div class="w-full max-w-sm p-4 sm:p-6 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl shadow-xl">
            <div class="text-center mb-4 sm:mb-6">
                <img src="static/kdt-logo.png" alt="KdT" class="h-10 sm:h-12 mx-auto mb-2 sm:mb-3">
                <h2 class="text-lg sm:text-xl font-semibold">Welcome to KdT AI</h2>
                <p class="text-xs sm:text-sm text-dark-500 dark:text-dark-400 mt-1">Please sign in to continue</p>
            </div>
            <form id="login-form" class="space-y-3 sm:space-y-4">
                <div>
                    <input type="text" id="login-username" placeholder="Username" required
                           class="w-full px-3 sm:px-4 py-2 sm:py-2.5 text-sm sm:text-base bg-dark-50 dark:bg-dark-800 border border-dark-200 dark:border-dark-700 rounded-lg text-dark-900 dark:text-dark-50 placeholder-dark-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div>
                    <input type="password" id="login-password" placeholder="Password" required
                           class="w-full px-3 sm:px-4 py-2 sm:py-2.5 text-sm sm:text-base bg-dark-50 dark:bg-dark-800 border border-dark-200 dark:border-dark-700 rounded-lg text-dark-900 dark:text-dark-50 placeholder-dark-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <p id="login-error" class="hidden text-xs sm:text-sm text-red-500 text-center">Invalid username or password</p>
                <button type="submit"
                        class="w-full px-4 py-2 sm:py-2.5 text-sm sm:text-base font-medium text-white bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg hover:from-indigo-600 hover:to-purple-700 transition-all">
                    Sign In
                </button>
            </form>
        </div>
    </div>
    <script>
        // Auth gate with server-side validation
        // Session persists for 6 hours using localStorage
        (function() {
            const gate = document.getElementById('login-gate');
            const form = document.getElementById('login-form');
            const errorMsg = document.getElementById('login-error');
            const SIX_HOURS = 6 * 60 * 60 * 1000; // 6 hours in milliseconds

            // Check if already authenticated (within 6 hours)
            function isAuthenticated() {
                const authTime = localStorage.getItem('kdt-auth-time');
                if (!authTime) return false;
                const elapsed = Date.now() - parseInt(authTime, 10);
                return elapsed < SIX_HOURS;
            }

            if (isAuthenticated()) {
                gate.style.display = 'none';
                // Warm up external services for returning users
                const warmupUrls = [
                    'https://grants-tracker-production.up.railway.app/health',
                    'https://kdttalentscout.up.railway.app/health',
                    'https://web-production-a9d068.up.railway.app/health',
                    'https://kdt.up.railway.app/health',
                    'https://policywatch.up.railway.app/health'
                ];
                warmupUrls.forEach(url => {
                    fetch(url, { mode: 'no-cors', cache: 'no-store' }).catch(() => {});
                });
                return;
            }

            // Clear expired auth
            localStorage.removeItem('kdt-auth-time');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                const submitBtn = form.querySelector('button[type="submit"]');

                // Disable button during login
                submitBtn.disabled = true;
                submitBtn.textContent = 'Signing in...';
                errorMsg.classList.add('hidden');

                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    if (response.ok) {
                        // Store auth timestamp for 6-hour persistence
                        localStorage.setItem('kdt-auth-time', Date.now().toString());

                        // Warm up external services in background (Railway cold start mitigation)
                        const warmupUrls = [
                            'https://grants-tracker-production.up.railway.app/health',
                            'https://kdttalentscout.up.railway.app/health',
                            'https://web-production-a9d068.up.railway.app/health',
                            'https://kdt.up.railway.app/health',
                            'https://policywatch.up.railway.app/health'
                        ];
                        warmupUrls.forEach(url => {
                            fetch(url, { mode: 'no-cors', cache: 'no-store' }).catch(() => {});
                        });

                        // Transition animation
                        const overlay = document.getElementById('transition-overlay');
                        const logo = document.getElementById('transition-logo');

                        // Match current theme for overlay background
                        if (document.documentElement.classList.contains('dark')) {
                            overlay.style.background = '#09090b';
                        } else {
                            overlay.style.background = '#fafafa';
                        }

                        // Show overlay instantly first
                        overlay.style.transition = 'none';
                        overlay.classList.add('active');

                        // Force reflow, then fade out login
                        overlay.offsetHeight;
                        gate.classList.add('fade-out');

                        // After login fades, show logo
                        setTimeout(() => {
                            gate.style.display = 'none';
                            logo.classList.add('visible');
                        }, 350);

                        // Hold, then fade out logo
                        setTimeout(() => {
                            logo.classList.remove('visible');
                        }, 1300);

                        // Hide overlay (restore transition for smooth fade out)
                        setTimeout(() => {
                            overlay.style.transition = 'opacity 0.3s ease';
                            overlay.classList.remove('active');
                        }, 1800);
                    } else {
                        errorMsg.classList.remove('hidden');
                        document.getElementById('login-password').value = '';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Sign In';
                    }
                } catch (error) {
                    errorMsg.textContent = 'Connection error. Please try again.';
                    errorMsg.classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Sign In';
                }
            });
        })();
    </script>

    <!-- Transition Overlay -->
    <div class="transition-overlay" id="transition-overlay">
        <img src="static/kdt-logo.png" alt="KdT" class="transition-logo" id="transition-logo">
    </div>

    <!-- Navigation -->
    <nav class="border-b border-dark-200 dark:border-dark-800 bg-dark-50/80 dark:bg-dark-950/80 backdrop-blur-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6">
            <div class="flex items-center justify-between h-14 sm:h-16 relative">
                <a href="/" class="flex items-center gap-2 sm:gap-3 z-10">
                    <img src="static/kdt-logo.png" alt="KdT" class="h-6 sm:h-8 w-auto">
                    <span class="text-base sm:text-lg font-semibold tracking-tight">KdT AI</span>
                </a>

                <!-- Expanded Search Bar - Full width overlay -->
                <div id="searchExpanded"
                     class="absolute left-24 sm:left-28 right-12 top-1/2 -translate-y-1/2 hidden md:flex items-center bg-dark-50 dark:bg-dark-900 rounded-full shadow-xl border border-dark-200 dark:border-dark-700 overflow-hidden transition-all duration-300 ease-out opacity-0 pointer-events-none scale-x-0"
                     style="transform-origin: right center;">
                    <svg class="w-4 h-4 text-dark-400 ml-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input id="ragSearchInput"
                           type="text"
                           placeholder="Search or ask Neo a question..."
                           class="flex-1 px-3 py-2 text-sm bg-transparent border-none focus:outline-none focus:ring-0 text-dark-800 dark:text-dark-200 placeholder-dark-400 min-w-0"
                           autocomplete="off">
                    <button id="searchClose" class="p-2 mr-1 text-dark-400 hover:text-dark-600 dark:hover:text-dark-200 rounded-full hover:bg-dark-200 dark:hover:bg-dark-700 transition-colors flex-shrink-0">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Desktop Navigation -->
                <div id="navLinks" class="hidden md:flex items-center gap-4 transition-opacity duration-200">
                    <a href="#tools" class="text-sm text-dark-600 dark:text-dark-300 hover:text-indigo-500 dark:hover:text-indigo-400 transition-colors">Tools</a>
                    <a href="#market" class="text-sm text-dark-600 dark:text-dark-300 hover:text-indigo-500 dark:hover:text-indigo-400 transition-colors">Market</a>
                    <a href="#trials" class="text-sm text-dark-600 dark:text-dark-300 hover:text-indigo-500 dark:hover:text-indigo-400 transition-colors">Trials</a>
                    <a href="#fda" class="text-sm text-dark-600 dark:text-dark-300 hover:text-indigo-500 dark:hover:text-indigo-400 transition-colors">FDA</a>

                    <!-- RAG Search Bar - Collapsed State -->
                    <button id="searchToggle"
                            class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-dark-100 dark:bg-dark-800 hover:bg-dark-200 dark:hover:bg-dark-700 border border-dark-200 dark:border-dark-700 transition-all duration-300 ease-out"
                            aria-label="Search">
                        <svg class="w-4 h-4 text-dark-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <span class="text-xs text-dark-400 hidden sm:inline">Search</span>
                        <kbd class="hidden sm:inline text-[10px] px-1.5 py-0.5 rounded bg-dark-200 dark:bg-dark-700 text-dark-400">/</kbd>
                    </button>

                    <!-- Theme Toggle -->
                    <button id="themeToggle"
                            class="p-2 rounded-lg bg-dark-100 dark:bg-dark-800 hover:bg-dark-200 dark:hover:bg-dark-700 transition-colors"
                            aria-label="Toggle theme">
                        <!-- Sun icon (shown in dark mode) -->
                        <svg class="w-5 h-5 hidden dark:block text-dark-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        <!-- Moon icon (shown in light mode) -->
                        <svg class="w-5 h-5 block dark:hidden text-dark-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                        </svg>
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="flex md:hidden items-center gap-2">
                    <!-- Mobile Search Button -->
                    <button id="mobileSearchToggle"
                            class="p-2 rounded-lg bg-dark-100 dark:bg-dark-800 hover:bg-dark-200 dark:hover:bg-dark-700 transition-colors"
                            aria-label="Search">
                        <svg class="w-5 h-5 text-dark-500 dark:text-dark-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </button>
                    <!-- Theme Toggle (Mobile) -->
                    <button id="themeToggleMobile"
                            class="p-2 rounded-lg bg-dark-100 dark:bg-dark-800 hover:bg-dark-200 dark:hover:bg-dark-700 transition-colors"
                            aria-label="Toggle theme">
                        <!-- Sun icon (shown in dark mode) -->
                        <svg class="w-5 h-5 hidden dark:block text-dark-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        <!-- Moon icon (shown in light mode) -->
                        <svg class="w-5 h-5 block dark:hidden text-dark-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                        </svg>
                    </button>
                    <!-- Hamburger Menu Button -->
                    <button id="mobileMenuToggle"
                            class="p-2 rounded-lg bg-dark-100 dark:bg-dark-800 hover:bg-dark-200 dark:hover:bg-dark-700 transition-colors"
                            aria-label="Toggle menu">
                        <svg id="hamburgerIcon" class="w-5 h-5 text-dark-500 dark:text-dark-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                        <svg id="closeIcon" class="w-5 h-5 text-dark-500 dark:text-dark-400 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobileMenu" class="hidden md:hidden border-t border-dark-200 dark:border-dark-800 py-3">
                <div class="flex flex-col space-y-2">
                    <a href="#tools" class="mobile-nav-link px-3 py-2 text-sm text-dark-600 dark:text-dark-300 hover:bg-dark-100 dark:hover:bg-dark-800 rounded-lg transition-colors">Tools</a>
                    <a href="#market" class="mobile-nav-link px-3 py-2 text-sm text-dark-600 dark:text-dark-300 hover:bg-dark-100 dark:hover:bg-dark-800 rounded-lg transition-colors">Market Overview</a>
                    <a href="#trials" class="mobile-nav-link px-3 py-2 text-sm text-dark-600 dark:text-dark-300 hover:bg-dark-100 dark:hover:bg-dark-800 rounded-lg transition-colors">Clinical Trials</a>
                    <a href="#fda" class="mobile-nav-link px-3 py-2 text-sm text-dark-600 dark:text-dark-300 hover:bg-dark-100 dark:hover:bg-dark-800 rounded-lg transition-colors">FDA Calendar</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="py-8 sm:py-12 md:py-16 lg:py-24 relative">
        <!-- Floating Particles -->
        <div class="particles" id="particles"></div>
        <div class="max-w-6xl mx-auto px-4 sm:px-6 text-center relative z-10">
            <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold tracking-tight mb-2 sm:mb-3 md:mb-4">
                Welcome to <span class="hero-gradient">KdT AI</span>
            </h1>
            <p class="text-sm sm:text-base md:text-lg text-dark-500 dark:text-dark-400 max-w-2xl mx-auto px-4 sm:px-0">
                Your AI toolkit for venture
            </p>
        </div>
    </section>

    <!-- Tools Grid -->
    <main id="tools" class="pb-4 sm:pb-6 scroll-mt-16 sm:scroll-mt-20">
        <div class="max-w-6xl mx-auto px-3 sm:px-4 md:px-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 md:gap-6">

                <!-- Portfolio Beacon -->
                <a href="https://web-production-a9d068.up.railway.app/" target="_blank" rel="noopener" data-key="1" class="group relative block p-4 sm:p-5 md:p-6 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl hover:border-dark-300 dark:hover:border-dark-700 hover:shadow-lg dark:hover:shadow-dark-900/50 transform hover:scale-[1.02] transition-all duration-200 card-glow card-animate">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/25 icon-container">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base sm:text-lg font-semibold group-hover:text-indigo-500 dark:group-hover:text-indigo-400 transition-colors">Portfolio Beacon</h3>
                            <p class="text-sm text-dark-500 dark:text-dark-400 leading-relaxed mt-1">Real-time portfolio updates and competitive intelligence</p>
                        </div>
                    </div>
                </a>

                <!-- Talent Scout -->
                <a href="https://kdttalentscout.up.railway.app/" target="_blank" rel="noopener" data-key="2" class="group relative block p-4 sm:p-5 md:p-6 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl hover:border-dark-300 dark:hover:border-dark-700 hover:shadow-lg dark:hover:shadow-dark-900/50 transform hover:scale-[1.02] transition-all duration-200 card-glow card-animate">
                    <span class="absolute -top-2 -right-2 px-2 py-0.5 text-xs font-medium bg-emerald-500 text-white rounded-full">New</span>
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center shadow-lg shadow-violet-500/25 icon-container">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base sm:text-lg font-semibold group-hover:text-indigo-500 dark:group-hover:text-indigo-400 transition-colors">Talent Scout</h3>
                            <p class="text-sm text-dark-500 dark:text-dark-400 leading-relaxed mt-1">Track h-indexes, discover rising stars, and monitor key researchers</p>
                        </div>
                    </div>
                </a>

                <!-- Conference Navigator -->
                <a href="https://chatgpt.com/g/g-688fe050ef388191ab360781596d2c10-portfolio-specific-biotech-analyst" target="_blank" rel="noopener" data-key="3" class="group relative block p-4 sm:p-5 md:p-6 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl hover:border-dark-300 dark:hover:border-dark-700 hover:shadow-lg dark:hover:shadow-dark-900/50 transform hover:scale-[1.02] transition-all duration-200 card-glow card-animate">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center shadow-lg shadow-emerald-500/25 icon-container">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base sm:text-lg font-semibold group-hover:text-indigo-500 dark:group-hover:text-indigo-400 transition-colors">Conference Navigator</h3>
                            <p class="text-sm text-dark-500 dark:text-dark-400 leading-relaxed mt-1">Plan conference strategies and analyze portfolio relevance</p>
                        </div>
                    </div>
                </a>

                <!-- Deal Watchdog -->
                <a href="https://kdt.up.railway.app/" target="_blank" rel="noopener" data-key="4" class="group relative block p-4 sm:p-5 md:p-6 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl hover:border-dark-300 dark:hover:border-dark-700 hover:shadow-lg dark:hover:shadow-dark-900/50 transform hover:scale-[1.02] transition-all duration-200 card-glow card-animate">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center shadow-lg shadow-orange-500/25 icon-container">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base sm:text-lg font-semibold group-hover:text-indigo-500 dark:group-hover:text-indigo-400 transition-colors flex items-center gap-1.5">
                                Deal Watchdog
                                <svg class="w-3.5 h-3.5 text-dark-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>
                            </h3>
                            <p class="text-sm text-dark-500 dark:text-dark-400 leading-relaxed mt-1">Track and monitor biotech deals and transactions</p>
                        </div>
                    </div>
                </a>

                <!-- Patent Warrior -->
                <a href="https://patentwarrior.up.railway.app" target="_blank" rel="noopener" data-key="5" class="group relative block p-4 sm:p-5 md:p-6 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl hover:border-dark-300 dark:hover:border-dark-700 hover:shadow-lg dark:hover:shadow-dark-900/50 transform hover:scale-[1.02] transition-all duration-200 card-glow card-animate">
                    <span class="absolute -top-2 -right-2 px-2 py-0.5 text-xs font-medium bg-indigo-500/80 text-white rounded-full">In Development</span>
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-br from-amber-500 to-yellow-600 flex items-center justify-center shadow-lg shadow-amber-500/25 icon-container">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base sm:text-lg font-semibold group-hover:text-indigo-500 dark:group-hover:text-indigo-400 transition-colors">Patent Warrior</h3>
                            <p class="text-sm text-dark-500 dark:text-dark-400 leading-relaxed mt-1">Patent application tracking and IP intelligence</p>
                        </div>
                    </div>
                </a>

                <!-- Grant Radar -->
                <a href="https://grants-tracker-production.up.railway.app" target="_blank" rel="noopener" data-key="6" class="group relative block p-4 sm:p-5 md:p-6 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl hover:border-dark-300 dark:hover:border-dark-700 hover:shadow-lg dark:hover:shadow-dark-900/50 transform hover:scale-[1.02] transition-all duration-200 card-glow card-animate">
                    <span class="absolute -top-2 -right-2 px-2 py-0.5 text-xs font-medium bg-emerald-500 text-white rounded-full">New</span>
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center shadow-lg shadow-cyan-500/25 icon-container">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base sm:text-lg font-semibold group-hover:text-indigo-500 dark:group-hover:text-indigo-400 transition-colors">Grant Radar</h3>
                            <p class="text-sm text-dark-500 dark:text-dark-400 leading-relaxed mt-1">Track NIH grants, SBIR awards, and funding to key researchers</p>
                        </div>
                    </div>
                </a>

                <!-- Policy Watch -->
                <a href="https://policywatch.up.railway.app" target="_blank" rel="noopener" data-key="7" class="group relative block p-4 sm:p-5 md:p-6 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl hover:border-dark-300 dark:hover:border-dark-700 hover:shadow-lg dark:hover:shadow-dark-900/50 transform hover:scale-[1.02] transition-all duration-200 card-glow card-animate">
                    <span class="absolute -top-2 -right-2 px-2 py-0.5 text-xs font-medium bg-indigo-500/80 text-white rounded-full">In Development</span>
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center shadow-lg shadow-rose-500/25 icon-container">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base sm:text-lg font-semibold group-hover:text-indigo-500 dark:group-hover:text-indigo-400 transition-colors">Policy Watch</h3>
                            <p class="text-sm text-dark-500 dark:text-dark-400 leading-relaxed mt-1">Track legislation impacting biotech and deeptech startups</p>
                        </div>
                    </div>
                </a>

                <!-- SEC Sentinel (Coming Soon) -->
                <div data-key="8" class="group relative block p-4 sm:p-5 md:p-6 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl opacity-60 cursor-default">
                    <span class="absolute -top-2 -right-2 px-2 py-0.5 text-xs font-medium bg-dark-500 text-white rounded-full">Coming Soon</span>
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-br from-slate-500 to-gray-600 flex items-center justify-center shadow-lg shadow-slate-500/25 icon-container">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base sm:text-lg font-semibold text-dark-400 dark:text-dark-500">SEC Sentinel</h3>
                            <p class="text-sm text-dark-400 dark:text-dark-500 leading-relaxed mt-1">Track biotech SEC filings, IPOs, and material events</p>
                        </div>
                    </div>
                </div>

                <!-- Coming Soon Teaser -->
                <div data-key="9" class="group relative block p-4 sm:p-5 md:p-6 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 border-dashed rounded-xl opacity-50 cursor-default">
                    <span class="absolute -top-2 -right-2 px-2 py-0.5 text-xs font-medium bg-dark-500 text-white rounded-full">Coming Soon</span>
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-br from-dark-400 to-dark-500 flex items-center justify-center shadow-lg shadow-dark-500/25 icon-container">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base sm:text-lg font-semibold text-dark-400 dark:text-dark-500">Something new is brewing...</h3>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Floating Biotech News Ticker -->
    <div class="fixed bottom-0 left-0 right-0 z-40 bg-dark-900/95 dark:bg-dark-950/95 backdrop-blur-sm border-t border-dark-700 dark:border-dark-800">
        <div class="flex items-center h-8 sm:h-10">
            <div class="flex-shrink-0 px-2 sm:px-4 h-full flex items-center bg-red-600">
                <span class="text-[10px] sm:text-xs font-bold text-white tracking-wide">LIVE</span>
            </div>
            <div id="ticker-wrapper" class="ticker-wrapper flex-1 overflow-hidden cursor-pointer" title="Tap to pause">
                <div id="news-ticker" class="ticker-content text-xs sm:text-sm text-dark-200">
                    <span class="inline-flex items-center gap-6">
                        <span class="text-dark-400">Loading biotech news...</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- XBI Market Data Section -->
    <section id="market" class="pt-4 pb-8 sm:pt-6 sm:pb-12 md:pb-16 scroll-mt-16 sm:scroll-mt-20">
        <div class="max-w-6xl mx-auto px-3 sm:px-4 md:px-6">
            <div class="mb-4 sm:mb-6">
                <h2 class="text-lg sm:text-xl md:text-2xl font-semibold tracking-tight mb-1">Market Overview</h2>
                <p class="text-xs sm:text-sm text-dark-500 dark:text-dark-400">SPDR S&P Biotech ETF (XBI)</p>
            </div>
            <div class="bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl overflow-hidden relative">
                <!-- Loading Skeleton -->
                <div id="chart-skeleton" class="absolute inset-0 skeleton z-10"></div>
                <!-- TradingView Widget -->
                <div id="tradingview-widget" class="tradingview-widget-container h-[280px] sm:h-[350px] md:h-[400px]">
                    <div id="tradingview-chart" style="height: 100%;"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Clinical Trials Section -->
    <section id="trials" class="pb-6 sm:pb-8 md:pb-12 scroll-mt-16 sm:scroll-mt-20">
        <div class="max-w-6xl mx-auto px-3 sm:px-4 md:px-6">
            <div class="mb-4 sm:mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <div>
                    <h2 class="text-lg sm:text-xl md:text-2xl font-semibold tracking-tight mb-1">Clinical Trials Tracker</h2>
                    <p class="text-xs sm:text-sm text-dark-500 dark:text-dark-400 flex items-center gap-1">
                        Recent trials and results from ClinicalTrials.gov
                        <span class="relative group cursor-help hidden sm:inline">
                            <svg class="w-4 h-4 text-dark-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 text-xs text-white bg-dark-800 dark:bg-dark-700 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                12 most recently updated
                            </span>
                        </span>
                    </p>
                </div>
                <a href="https://clinicaltrials.gov/search?aggFilters=phase:2%203,status:rec%20act%20not&viewType=Table" target="_blank" rel="noopener"
                   class="text-xs text-indigo-500 hover:text-indigo-600 dark:text-indigo-400 dark:hover:text-indigo-300 self-start sm:self-auto">
                    View All Trials 
                </a>
            </div>
            <!-- Filter tabs -->
            <div class="flex gap-1.5 sm:gap-2 mb-3 sm:mb-4 overflow-x-auto pb-2 -mx-3 px-3 sm:mx-0 sm:px-0">
                <button class="trials-tab active px-2.5 sm:px-3 py-1 sm:py-1.5 text-xs font-medium rounded-full bg-indigo-500 text-white whitespace-nowrap" data-filter="recent">
                    Recently Posted
                </button>
                <button class="trials-tab px-2.5 sm:px-3 py-1 sm:py-1.5 text-xs font-medium rounded-full bg-dark-100 dark:bg-dark-800 text-dark-600 dark:text-dark-300 hover:bg-dark-200 dark:hover:bg-dark-700 whitespace-nowrap" data-filter="results">
                    Results Available
                </button>
                <button class="trials-tab px-2.5 sm:px-3 py-1 sm:py-1.5 text-xs font-medium rounded-full bg-dark-100 dark:bg-dark-800 text-dark-600 dark:text-dark-300 hover:bg-dark-200 dark:hover:bg-dark-700 whitespace-nowrap" data-filter="phase1">
                    Phase 1
                </button>
                <button class="trials-tab px-2.5 sm:px-3 py-1 sm:py-1.5 text-xs font-medium rounded-full bg-dark-100 dark:bg-dark-800 text-dark-600 dark:text-dark-300 hover:bg-dark-200 dark:hover:bg-dark-700 whitespace-nowrap" data-filter="phase2">
                    Phase 2
                </button>
                <button class="trials-tab px-2.5 sm:px-3 py-1 sm:py-1.5 text-xs font-medium rounded-full bg-dark-100 dark:bg-dark-800 text-dark-600 dark:text-dark-300 hover:bg-dark-200 dark:hover:bg-dark-700 whitespace-nowrap" data-filter="phase3">
                    Phase 3
                </button>
            </div>
            <div id="trials-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                <!-- Loading skeletons -->
                <div class="trials-skeleton p-3 sm:p-4 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl">
                    <div class="h-3 w-16 skeleton rounded mb-2"></div>
                    <div class="h-4 w-full skeleton rounded mb-2"></div>
                    <div class="h-4 w-3/4 skeleton rounded mb-3"></div>
                    <div class="h-3 w-24 skeleton rounded"></div>
                </div>
                <div class="trials-skeleton p-3 sm:p-4 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl">
                    <div class="h-3 w-16 skeleton rounded mb-2"></div>
                    <div class="h-4 w-full skeleton rounded mb-2"></div>
                    <div class="h-4 w-3/4 skeleton rounded mb-3"></div>
                    <div class="h-3 w-24 skeleton rounded"></div>
                </div>
                <div class="trials-skeleton p-3 sm:p-4 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl hidden sm:block">
                    <div class="h-3 w-16 skeleton rounded mb-2"></div>
                    <div class="h-4 w-full skeleton rounded mb-2"></div>
                    <div class="h-4 w-3/4 skeleton rounded mb-3"></div>
                    <div class="h-3 w-24 skeleton rounded"></div>
                </div>
            </div>
            <p id="trials-footer" class="text-xs text-dark-400 mt-4 text-center">Loading trials from ClinicalTrials.gov...</p>
        </div>
    </section>

    <!-- FDA Calendar Widget -->
    <section id="fda" class="pb-6 sm:pb-8 md:pb-12 scroll-mt-16 sm:scroll-mt-20">
        <div class="max-w-6xl mx-auto px-3 sm:px-4 md:px-6">
            <div class="mb-4 sm:mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <div>
                    <h2 class="text-lg sm:text-xl md:text-2xl font-semibold tracking-tight mb-1">Upcoming FDA Dates</h2>
                    <p class="text-xs sm:text-sm text-dark-500 dark:text-dark-400">Key PDUFA dates</p>
                </div>
                <a href="https://www.fdatracker.com/fda-calendar/" target="_blank" rel="noopener"
                   class="text-xs text-indigo-500 hover:text-indigo-600 dark:text-indigo-400 dark:hover:text-indigo-300 self-start sm:self-auto">
                    View Full Calendar 
                </a>
            </div>
            <div id="fda-calendar" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                <!-- Loading skeletons -->
                <div class="fda-skeleton p-3 sm:p-4 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl">
                    <div class="flex items-start justify-between gap-2 sm:gap-3">
                        <div class="flex-1">
                            <div class="h-3 w-12 skeleton rounded mb-2"></div>
                            <div class="h-4 w-32 skeleton rounded mb-2"></div>
                            <div class="h-3 w-24 skeleton rounded"></div>
                        </div>
                        <div class="text-right">
                            <div class="h-5 w-14 skeleton rounded mb-1"></div>
                            <div class="h-3 w-10 skeleton rounded"></div>
                        </div>
                    </div>
                </div>
                <div class="fda-skeleton p-3 sm:p-4 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl">
                    <div class="flex items-start justify-between gap-2 sm:gap-3">
                        <div class="flex-1">
                            <div class="h-3 w-12 skeleton rounded mb-2"></div>
                            <div class="h-4 w-32 skeleton rounded mb-2"></div>
                            <div class="h-3 w-24 skeleton rounded"></div>
                        </div>
                        <div class="text-right">
                            <div class="h-5 w-14 skeleton rounded mb-1"></div>
                            <div class="h-3 w-10 skeleton rounded"></div>
                        </div>
                    </div>
                </div>
                <div class="fda-skeleton p-3 sm:p-4 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl hidden sm:block">
                    <div class="flex items-start justify-between gap-2 sm:gap-3">
                        <div class="flex-1">
                            <div class="h-3 w-12 skeleton rounded mb-2"></div>
                            <div class="h-4 w-32 skeleton rounded mb-2"></div>
                            <div class="h-3 w-24 skeleton rounded"></div>
                        </div>
                        <div class="text-right">
                            <div class="h-5 w-14 skeleton rounded mb-1"></div>
                            <div class="h-3 w-10 skeleton rounded"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Floating Feedback Button -->
    <div id="feedbackWidget" class="fixed bottom-16 right-3 sm:right-6 z-50">
        <!-- Expanded Form -->
        <div id="feedbackPanel" class="hidden mb-3 w-64 sm:w-72 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl shadow-xl p-3 sm:p-4">
            <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-medium">Send Feedback</span>
                <button id="closeFeedback" class="text-dark-400 hover:text-dark-600 dark:hover:text-dark-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="feedbackForm" action="https://formsubmit.co/ajax/sanirudh0331@gmail.com" method="POST" class="space-y-2">
                <input type="hidden" name="_subject" value="KdT AI Landing Page Feedback">
                <input type="hidden" name="_captcha" value="false">
                <input type="text" name="name" placeholder="Your name" required
                       class="w-full px-3 py-2 text-sm bg-dark-50 dark:bg-dark-800 border border-dark-200 dark:border-dark-700 rounded-lg text-dark-900 dark:text-dark-50 placeholder-dark-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                <input type="email" name="email" placeholder="Your email" required
                       class="w-full px-3 py-2 text-sm bg-dark-50 dark:bg-dark-800 border border-dark-200 dark:border-dark-700 rounded-lg text-dark-900 dark:text-dark-50 placeholder-dark-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                <textarea name="message" rows="3" placeholder="Your feedback..." required
                          class="w-full px-3 py-2 text-sm bg-dark-50 dark:bg-dark-800 border border-dark-200 dark:border-dark-700 rounded-lg text-dark-900 dark:text-dark-50 placeholder-dark-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all resize-none"></textarea>
                <button type="submit" id="feedbackSubmit"
                        class="w-full px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg hover:from-indigo-600 hover:to-purple-700 transition-all">
                    Send
                </button>
            </form>
            <p id="feedbackSuccess" class="hidden mt-2 text-xs text-green-600 dark:text-green-400 text-center">Thanks for your feedback!</p>
        </div>
        <!-- Toggle Button -->
        <button id="feedbackToggle"
                class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all hover:scale-105">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
        </button>
    </div>

    <!-- RAG Search Results Modal -->
    <div id="searchResultsModal" class="hidden fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 sm:p-6 md:p-8">
        <div class="w-full max-w-5xl lg:max-w-6xl bg-dark-50 dark:bg-dark-900 rounded-xl shadow-2xl border border-dark-200 dark:border-dark-700 h-[90vh] sm:h-[85vh] max-h-[900px] flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-3 border-b border-dark-200 dark:border-dark-700">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <span class="text-sm text-dark-600 dark:text-dark-300">Results for:</span>
                    <span id="searchResultsQuery" class="font-medium text-dark-800 dark:text-dark-200"></span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="clearSearch" class="p-1 rounded hover:bg-dark-200 dark:hover:bg-dark-700 text-dark-400" title="Clear">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                    <button id="closeSearchResults" class="p-1 rounded hover:bg-dark-200 dark:hover:bg-dark-700 text-dark-400" title="Close">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Tabs -->
            <div class="flex border-b border-dark-200 dark:border-dark-700 px-4">
                <button id="tabSearch" class="px-4 py-2 text-sm font-medium border-b-2 border-indigo-500 text-indigo-600 dark:text-indigo-400 -mb-px">
                    Search Results
                </button>
                <button id="tabAsk" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-dark-500 hover:text-dark-700 dark:hover:text-dark-300 -mb-px">
                    Ask Neo
                </button>
            </div>
            <!-- Loading -->
            <div id="searchLoading" class="hidden py-12 text-center">
                <img src="static/kdt-logo.png" alt="Loading" class="w-12 h-12 mx-auto animate-pulse opacity-70">
                <p id="loadingText" class="text-sm text-dark-500 mt-3">Searching across all tools...</p>
            </div>
            <!-- Search Results Panel -->
            <div id="searchResultsList" class="flex-1 overflow-y-auto p-4">
                <!-- Results populated by JavaScript -->
            </div>
            <!-- AI Chat Panel -->
            <div id="askResultsPanel" class="hidden flex-1 flex flex-col overflow-hidden relative">
                <!-- Model selector and clear chat button -->
                <div class="flex items-center justify-between px-4 py-2 border-b border-dark-200 dark:border-dark-700">
                    <button id="clearChat" class="text-xs text-dark-500 hover:text-dark-700 dark:hover:text-dark-300 flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Clear chat
                    </button>
                    <div class="flex items-center">
                        <label class="text-xs text-dark-500 mr-2">Model:</label>
                        <select id="modelSelector" class="text-xs bg-white dark:bg-dark-700 border border-dark-300 dark:border-dark-500 rounded px-2 py-1 text-dark-800 dark:text-white focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="claude-3-5-haiku-20241022">Haiku (Fast)</option>
                            <option value="claude-sonnet-4-20250514">Sonnet</option>
                            <option value="claude-opus-4-20250514">Opus (Best)</option>
                        </select>
                    </div>
                </div>
                <!-- Subtle background logo watermark -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-[0.03] dark:opacity-[0.05] z-0">
                    <img src="static/kdt-logo.png" alt="" class="w-48 h-48 object-contain">
                </div>
                <!-- Chat messages area (scrollable) -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 relative z-10">
                    <!-- Welcome message shown when empty -->
                    <div id="chatWelcome" class="flex flex-col items-center justify-center h-full text-center">
                        <img src="static/kdt-logo.png" class="w-12 h-12 mb-3 opacity-60">
                        <h3 class="text-lg font-semibold text-dark-700 dark:text-dark-300 mb-2">KdT Neo</h3>
                        <p class="text-sm text-dark-400 max-w-xs">Ask Neo anything about KdT's knowledge base</p>
                    </div>
                </div>
                <!-- Sources area (shown after responses) -->
                <div id="askSources" class="px-4 pb-2 hidden border-t border-dark-200 dark:border-dark-700 pt-3">
                    <!-- Sources list populated by JavaScript -->
                </div>
                <!-- Chat input area -->
                <div class="p-3 border-t border-dark-200 dark:border-dark-700 bg-dark-100/50 dark:bg-dark-800/50">
                    <form id="chatInputForm" class="flex gap-2">
                        <input type="text" id="chatInput"
                               placeholder="Continue the conversation..."
                               class="flex-1 px-4 py-2.5 rounded-lg bg-white dark:bg-dark-700 border border-dark-300 dark:border-dark-600 text-dark-800 dark:text-white placeholder-dark-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                               autocomplete="off">
                        <button type="submit" id="chatSendBtn"
                                class="px-4 py-2.5 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium text-sm transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span>Send</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
            <!-- Footer hint -->
            <div class="px-4 py-2 border-t border-dark-200 dark:border-dark-700 text-xs text-dark-400 flex items-center justify-between">
                <span>Press <kbd class="px-1.5 py-0.5 bg-dark-200 dark:bg-dark-700 rounded">Esc</kbd> to close</span>
                <span id="footerRight">Press <kbd class="px-1.5 py-0.5 bg-dark-200 dark:bg-dark-700 rounded">/</kbd> to search</span>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-dark-200 dark:border-dark-800 mb-12 sm:mb-10">
        <div class="max-w-6xl mx-auto px-3 sm:px-4 md:px-6 py-4 sm:py-6 md:py-8">
            <div class="text-center text-xs sm:text-sm text-dark-500 dark:text-dark-500">
                Powered by KdT AI
            </div>
        </div>
    </footer>

    <!-- TradingView Widget Script -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        function initTradingViewWidget() {
            const isDark = document.documentElement.classList.contains('dark');
            const container = document.getElementById('tradingview-chart');
            container.innerHTML = '';

            new TradingView.widget({
                "autosize": true,
                "symbol": "AMEX:XBI",
                "interval": "D",
                "timezone": "America/New_York",
                "theme": isDark ? "dark" : "light",
                "style": "1",
                "locale": "en",
                "toolbar_bg": isDark ? "#18181b" : "#ffffff",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": false,
                "container_id": "tradingview-chart",
                "hide_volume": true
            });
        }

        // Initialize widget on load
        initTradingViewWidget();

        // Mobile Menu Toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const mobileMenu = document.getElementById('mobileMenu');
        const hamburgerIcon = document.getElementById('hamburgerIcon');
        const closeIcon = document.getElementById('closeIcon');

        mobileMenuToggle.addEventListener('click', () => {
            const isOpen = !mobileMenu.classList.contains('hidden');
            mobileMenu.classList.toggle('hidden');
            hamburgerIcon.classList.toggle('hidden');
            closeIcon.classList.toggle('hidden');
        });

        // Close mobile menu when clicking a nav link
        document.querySelectorAll('.mobile-nav-link').forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.add('hidden');
                hamburgerIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
            });
        });

        // Theme Toggle Script (both desktop and mobile)
        const themeToggle = document.getElementById('themeToggle');
        const themeToggleMobile = document.getElementById('themeToggleMobile');

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            // Reinitialize widget with new theme
            setTimeout(initTradingViewWidget, 100);
        }

        if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
        if (themeToggleMobile) themeToggleMobile.addEventListener('click', toggleTheme);

        // Generate floating particles
        function createParticles() {
            const container = document.getElementById('particles');
            const particleCount = 20;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (10 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }
        createParticles();

        // Feedback widget toggle
        const feedbackToggle = document.getElementById('feedbackToggle');
        const feedbackPanel = document.getElementById('feedbackPanel');
        const closeFeedback = document.getElementById('closeFeedback');
        const feedbackForm = document.getElementById('feedbackForm');
        const feedbackSuccess = document.getElementById('feedbackSuccess');

        feedbackToggle.addEventListener('click', () => {
            feedbackPanel.classList.toggle('hidden');
        });

        closeFeedback.addEventListener('click', () => {
            feedbackPanel.classList.add('hidden');
        });

        feedbackForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('feedbackSubmit');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Sending...';
            submitBtn.disabled = true;

            try {
                const formData = new FormData(feedbackForm);
                const response = await fetch(feedbackForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    feedbackForm.reset();
                    feedbackSuccess.classList.remove('hidden');
                    setTimeout(() => {
                        feedbackSuccess.classList.add('hidden');
                        feedbackPanel.classList.add('hidden');
                    }, 2000);
                } else {
                    alert('Failed to send feedback. Please try again.');
                }
            } catch (error) {
                alert('Failed to send feedback. Please try again.');
            }

            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });

        // Keyboard shortcuts (1-7) to navigate to tools
        document.addEventListener('keydown', (e) => {
            // Don't trigger if user is typing in an input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            const key = e.key;
            if (key >= '1' && key <= '7') {
                const card = document.querySelector(`a[data-key="${key}"]`);
                if (card && card.href && card.href !== '#') {
                    window.open(card.href, '_blank');
                }
            }
        });

        // Hide loading skeleton when TradingView widget loads
        const chartSkeleton = document.getElementById('chart-skeleton');
        const observer = new MutationObserver((mutations) => {
            const chartContainer = document.getElementById('tradingview-chart');
            // Check if TradingView has added its iframe
            if (chartContainer && chartContainer.querySelector('iframe')) {
                chartSkeleton.style.display = 'none';
                observer.disconnect();
            }
        });
        observer.observe(document.getElementById('tradingview-chart'), { childList: true, subtree: true });

        // Fallback: hide skeleton after 3 seconds
        setTimeout(() => {
            chartSkeleton.style.display = 'none';
        }, 3000);

        // Fetch biotech news from backend API (server-side RSS fetching)
        async function fetchBiotechNews() {
            try {
                const response = await fetch('/api/news');
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                return data.news || [];
            } catch (error) {
                console.warn('Failed to fetch news:', error);
                return [];
            }
        }

        async function populateNewsTicker() {
            const tickerEl = document.getElementById('news-ticker');
            const news = await fetchBiotechNews();

            if (news.length === 0) {
                tickerEl.innerHTML = '<span class="inline-flex items-center gap-6"><span class="text-dark-400">Unable to load news. Please try again later.</span></span>';
                return;
            }

            // Shuffle and pick top items
            const shuffled = news.sort(() => 0.5 - Math.random()).slice(0, 15);

            // Build ticker HTML (duplicate for seamless loop)
            const separator = '<span class="text-dark-500 mx-4"></span>';
            const newsHtml = shuffled.map(item =>
                `<a href="${item.link}" target="_blank" rel="noopener" class="text-dark-200 hover:text-white transition-colors">${item.title}</a>`
            ).join(separator);

            tickerEl.innerHTML = `<span class="inline-flex items-center gap-2">${newsHtml}${separator}${newsHtml}</span>`;
        }

        // Load news on page load
        populateNewsTicker();

        // Refresh news every 15 minutes
        setInterval(populateNewsTicker, 15 * 60 * 1000);

        // FDA Calendar
        let fdaEventsCache = null;

        async function loadFDACalendar() {
            const calendarEl = document.getElementById('fda-calendar');

            try {
                // Use cache if available
                if (!fdaEventsCache) {
                    const response = await fetch('/api/fda-calendar');
                    if (!response.ok) throw new Error('Failed to load');
                    const data = await response.json();
                    fdaEventsCache = data.events || [];
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const ninetyDaysOut = new Date(today);
                ninetyDaysOut.setDate(ninetyDaysOut.getDate() + 90);

                // Filter to events in next 90 days and sort by date
                const upcoming = fdaEventsCache
                    .filter(e => {
                        const eventDate = new Date(e.date + 'T00:00:00');
                        return eventDate >= today && eventDate <= ninetyDaysOut;
                    })
                    .sort((a, b) => new Date(a.date + 'T00:00:00') - new Date(b.date + 'T00:00:00'));

                if (upcoming.length === 0) {
                    calendarEl.innerHTML = '<div class="col-span-full text-center py-8 text-dark-400">No FDA dates in the next 90 days</div>';
                    return;
                }

                const formatDate = (dateStr) => {
                    const date = new Date(dateStr + 'T00:00:00');
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return {
                        month: months[date.getMonth()],
                        day: date.getDate(),
                        year: date.getFullYear()
                    };
                };

                const getDaysUntil = (dateStr) => {
                    const eventDate = new Date(dateStr + 'T00:00:00');
                    eventDate.setHours(0, 0, 0, 0);
                    const diffTime = eventDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays;
                };

                // Limit to 12 upcoming events
                const limitedEvents = upcoming.slice(0, 12);

                calendarEl.innerHTML = limitedEvents.map(event => {
                    const d = formatDate(event.date);
                    const daysUntil = getDaysUntil(event.date);
                    const typeColor = event.type === 'PDUFA' ? 'text-red-500' : 'text-blue-500';
                    const daysLabel = daysUntil === 0 ? 'Today' : daysUntil === 1 ? '1 day' : `${daysUntil} days`;

                    // Clean up company name (remove trailing backslashes, extra whitespace)
                    const cleanCompany = (event.company || '').replace(/\\+$/g, '').replace(/\s+/g, ' ').trim();

                    // Clean indication (skip if just "See details" or "Pending")
                    let indication = event.indication || '';
                    if (indication.toLowerCase().includes('see details') || indication.toLowerCase().includes('pending')) {
                        indication = '';
                    }
                    // Format indication: sentence case
                    if (indication) {
                        indication = indication.charAt(0).toUpperCase() + indication.slice(1).toLowerCase();
                    }

                    // Check if there's a press release URL
                    const hasUrl = event.url && event.url.startsWith('http');

                    const cardContent = `
                        <div class="flex items-start justify-between gap-3">
                            <div class="min-w-0 flex-1">
                                <div class="text-xs font-medium ${typeColor} uppercase tracking-wide mb-1">${event.type}</div>
                                <h4 class="font-semibold text-sm mb-1 truncate">${cleanCompany}</h4>
                                ${indication ? `<div class="scroll-container overflow-hidden h-4 relative"><p class="text-xs text-dark-500 dark:text-dark-400 whitespace-nowrap scroll-text">${indication}</p></div>` : ''}
                            </div>
                            <div class="text-right flex-shrink-0">
                                <div class="text-lg font-bold">${d.month} ${d.day}</div>
                                <div class="text-xs text-indigo-500 dark:text-indigo-400 font-medium">${daysLabel}</div>
                            </div>
                        </div>
                    `;

                    // Wrap in link if URL exists, otherwise just a div
                    if (hasUrl) {
                        return `<a href="${event.url}" target="_blank" rel="noopener" class="block p-4 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl hover:border-indigo-300 dark:hover:border-indigo-700 hover:shadow-md transition-all">${cardContent}</a>`;
                    } else {
                        return `<div class="p-4 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl">${cardContent}</div>`;
                    }
                }).join('');

                // Check for overflow and enable scrolling on long text
                setTimeout(() => {
                    document.querySelectorAll('#fda-calendar .scroll-text').forEach(el => {
                        if (el.scrollWidth > el.parentElement.clientWidth) {
                            el.classList.add('scrollable');
                            el.innerHTML = el.textContent + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + el.textContent;
                        }
                    });
                }, 100);

            } catch (error) {
                console.error('Failed to load FDA calendar:', error);
                calendarEl.innerHTML = '<div class="col-span-full text-center py-8 text-dark-400">Unable to load FDA calendar</div>';
            }
        }

        // Load FDA calendar
        loadFDACalendar();

        // Clinical Trials
        let trialsCache = { recent: null, results: null, phase1: null, phase2: null, phase3: null };

        async function fetchClinicalTrials(filter = 'recent') {
            const trialsGrid = document.getElementById('trials-grid');
            const trialsFooter = document.getElementById('trials-footer');

            // Use cache if available
            if (trialsCache[filter]) {
                renderTrials(trialsCache[filter], filter);
                return;
            }

            trialsGrid.innerHTML = `
                <div class="trials-skeleton p-4 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl">
                    <div class="h-3 w-16 skeleton rounded mb-2"></div>
                    <div class="h-4 w-full skeleton rounded mb-2"></div>
                    <div class="h-4 w-3/4 skeleton rounded mb-3"></div>
                    <div class="h-3 w-24 skeleton rounded"></div>
                </div>`.repeat(3);

            try {
                // Build query based on filter
                let queryParams = 'query.term=biotech OR oncology OR gene therapy&pageSize=12&sort=LastUpdatePostDate:desc';

                if (filter === 'recent') {
                    queryParams = 'query.term=biotech OR pharma&aggFilters=phase:1 2 3,status:rec act&pageSize=12&sort=LastUpdatePostDate:desc';
                } else if (filter === 'results') {
                    queryParams = 'query.term=biotech OR pharma&aggFilters=phase:1 2 3,results:with&pageSize=12&sort=ResultsFirstPostDate:desc';
                } else if (filter === 'phase1') {
                    queryParams = 'query.term=biotech OR pharma&aggFilters=phase:1,status:rec act&pageSize=12&sort=LastUpdatePostDate:desc';
                } else if (filter === 'phase2') {
                    queryParams = 'query.term=biotech OR pharma&aggFilters=phase:2,status:rec act&pageSize=12&sort=LastUpdatePostDate:desc';
                } else if (filter === 'phase3') {
                    queryParams = 'query.term=biotech OR pharma&aggFilters=phase:3,status:rec act&pageSize=12&sort=LastUpdatePostDate:desc';
                }

                const response = await fetch(`https://clinicaltrials.gov/api/v2/studies?${queryParams}`, {
                    signal: AbortSignal.timeout(10000)
                });

                if (!response.ok) throw new Error('API error');

                const data = await response.json();
                const trials = data.studies || [];

                trialsCache[filter] = trials;
                renderTrials(trials, filter);

            } catch (error) {
                console.error('Failed to fetch clinical trials:', error);
                trialsGrid.innerHTML = '<div class="col-span-full text-center py-8 text-dark-400">Unable to load clinical trials. Try refreshing.</div>';
                trialsFooter.textContent = '';
            }
        }

        function renderTrials(trials, filter) {
            const trialsGrid = document.getElementById('trials-grid');
            const trialsFooter = document.getElementById('trials-footer');

            if (!trials || trials.length === 0) {
                trialsGrid.innerHTML = '<div class="col-span-full text-center py-8 text-dark-400">No trials found</div>';
                trialsFooter.textContent = '';
                return;
            }

            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                // Parse as UTC to avoid timezone shifting the date back a day
                const date = new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            };

            trialsGrid.innerHTML = trials.slice(0, 9).map(study => {
                const protocol = study.protocolSection || {};
                const id = protocol.identificationModule || {};
                const status = protocol.statusModule || {};
                const sponsor = protocol.sponsorCollaboratorsModule?.leadSponsor?.name || 'Unknown';
                const phase = protocol.designModule?.phases?.[0] || 'N/A';
                const conditions = protocol.conditionsModule?.conditions?.slice(0, 2).join(', ') || 'N/A';

                const nctId = id.nctId || '';
                const title = id.briefTitle || 'Untitled Study';

                // Get relevant date
                const lastUpdate = status.lastUpdatePostDateStruct?.date;
                const resultsDate = study.resultsSection?.pointOfContactSection?.pointOfContactPhoneExt ||
                                   protocol.statusModule?.resultsFirstPostDateStruct?.date;
                const startDate = status.startDateStruct?.date;
                const displayDate = formatDate(lastUpdate || startDate);

                const overallStatus = status.overallStatus || '';
                const statusColor = overallStatus === 'RECRUITING' ? 'text-green-600 dark:text-green-400' :
                                   overallStatus === 'ACTIVE_NOT_RECRUITING' ? 'text-yellow-600 dark:text-yellow-400' :
                                   overallStatus === 'COMPLETED' ? 'text-blue-600 dark:text-blue-400' : 'text-dark-500';
                const statusLabel = overallStatus.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, l => l.toUpperCase());

                // Format phase label nicely
                const phaseLabel = phase.replace('PHASE', 'Phase ').replace('_', '/');
                const phaseColor = phase.includes('3') ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400' :
                                  phase.includes('2') ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400' :
                                  phase.includes('1') ? 'bg-teal-100 text-teal-700 dark:bg-teal-900/30 dark:text-teal-400' :
                                  'bg-dark-100 text-dark-600 dark:bg-dark-800 dark:text-dark-400';

                const hasResults = study.hasResults;

                return `
                    <a href="https://clinicaltrials.gov/study/${nctId}" target="_blank" rel="noopener"
                       class="flex flex-col p-4 bg-white dark:bg-dark-900 border border-dark-200 dark:border-dark-800 rounded-xl hover:border-indigo-300 dark:hover:border-indigo-700 hover:shadow-md transition-all group">
                        <div class="flex items-start justify-between gap-2 mb-3">
                            <div class="flex flex-wrap items-center gap-1.5">
                                <span class="px-2 py-0.5 text-xs font-medium rounded ${phaseColor}">${phaseLabel}</span>
                                ${hasResults ? '<span class="px-2 py-0.5 text-xs font-medium rounded bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">Results</span>' : ''}
                            </div>
                            <span class="text-xs text-dark-400 whitespace-nowrap">${displayDate}</span>
                        </div>
                        <h4 class="font-medium text-sm leading-relaxed mb-3 group-hover:text-indigo-500 dark:group-hover:text-indigo-400 transition-colors">${title}</h4>
                        <div class="mt-auto pt-3 border-t border-dark-100 dark:border-dark-800">
                            <p class="text-xs font-medium text-dark-600 dark:text-dark-300 mb-1">${sponsor}</p>
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-xs text-dark-400 truncate" title="${conditions}">${conditions}</span>
                                <span class="text-xs font-medium flex-shrink-0 ${statusColor}">${statusLabel}</span>
                            </div>
                        </div>
                    </a>
                `;
            }).join('');

            trialsFooter.textContent = '';
        }

        // Tab switching
        document.querySelectorAll('.trials-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.trials-tab').forEach(t => {
                    t.classList.remove('active', 'bg-indigo-500', 'text-white');
                    t.classList.add('bg-dark-100', 'dark:bg-dark-800', 'text-dark-600', 'dark:text-dark-300');
                });
                tab.classList.add('active', 'bg-indigo-500', 'text-white');
                tab.classList.remove('bg-dark-100', 'dark:bg-dark-800', 'text-dark-600', 'dark:text-dark-300');
                fetchClinicalTrials(tab.dataset.filter);
            });
        });

        // Load trials on page load
        fetchClinicalTrials('recent');

        // Refresh clinical trials every 10 minutes (clear cache to get fresh data)
        setInterval(() => {
            trialsCache = { recent: null, results: null, phase1: null, phase2: null, phase3: null };
            const activeTab = document.querySelector('.trials-tab.active');
            const filter = activeTab ? activeTab.dataset.filter : 'recent';
            fetchClinicalTrials(filter);
        }, 10 * 60 * 1000);

        // Ticker pause on tap (mobile)
        const tickerWrapper = document.getElementById('ticker-wrapper');
        tickerWrapper.addEventListener('click', () => {
            tickerWrapper.classList.toggle('ticker-paused');
        });
        tickerWrapper.addEventListener('touchstart', (e) => {
            tickerWrapper.classList.toggle('ticker-paused');
        }, { passive: true });

        // ============ RAG Search Functionality ============
        const searchToggle = document.getElementById('searchToggle');
        const searchExpanded = document.getElementById('searchExpanded');
        const ragSearchInput = document.getElementById('ragSearchInput');
        const searchClose = document.getElementById('searchClose');
        const searchResultsModal = document.getElementById('searchResultsModal');
        const searchResultsList = document.getElementById('searchResultsList');
        const searchResultsQuery = document.getElementById('searchResultsQuery');
        const closeSearchResults = document.getElementById('closeSearchResults');
        const clearSearch = document.getElementById('clearSearch');
        const modelSelector = document.getElementById('modelSelector');
        const searchLoading = document.getElementById('searchLoading');

        let searchTimeout = null;

        // Source colors for badges
        const sourceColors = {
            patents: 'bg-blue-500',
            grants: 'bg-green-500',
            researchers: 'bg-purple-500',
            policies: 'bg-orange-500',
            fda_calendar: 'bg-red-500'
        };

        const sourceLabels = {
            patents: 'Patent',
            grants: 'Grant',
            researchers: 'Researcher',
            policies: 'Policy',
            fda_calendar: 'FDA'
        };

        // Toggle search bar (desktop) - animated expand/collapse
        const navLinks = document.getElementById('navLinks');

        function expandSearch() {
            // Hide nav links
            navLinks?.classList.add('opacity-0', 'pointer-events-none');
            // Show expanded search bar
            searchExpanded.classList.remove('opacity-0', 'pointer-events-none', 'scale-x-0');
            searchExpanded.classList.add('opacity-100', 'scale-x-100');
            setTimeout(() => ragSearchInput?.focus(), 150);
        }

        function collapseSearch() {
            // Hide expanded search bar
            searchExpanded.classList.remove('opacity-100', 'scale-x-100');
            searchExpanded.classList.add('opacity-0', 'pointer-events-none', 'scale-x-0');
            // Show nav links
            navLinks?.classList.remove('opacity-0', 'pointer-events-none');
            ragSearchInput.value = '';
        }

        searchToggle?.addEventListener('click', expandSearch);

        // Mobile search - open modal directly with input
        const mobileSearchToggle = document.getElementById('mobileSearchToggle');
        mobileSearchToggle?.addEventListener('click', () => {
            searchResultsModal?.classList.remove('hidden');
            // Add a search input to the modal if on mobile
            if (!document.getElementById('mobileSearchInput')) {
                const header = searchResultsModal.querySelector('.flex.items-center.justify-between');
                if (header) {
                    const input = document.createElement('input');
                    input.id = 'mobileSearchInput';
                    input.type = 'text';
                    input.placeholder = 'Search...';
                    input.className = 'flex-1 px-3 py-1 text-sm bg-dark-100 dark:bg-dark-800 border-none rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-dark-800 dark:text-dark-200 placeholder-dark-400 mr-2';
                    header.insertBefore(input, header.firstChild.nextSibling);
                    input.focus();
                    input.addEventListener('input', (e) => {
                        const query = e.target.value.trim();
                        clearTimeout(searchTimeout);
                        if (query.length >= 2) {
                            searchTimeout = setTimeout(() => performRAGSearch(query), 300);
                        }
                    });
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            const query = input.value.trim();
                            if (query.length >= 2) {
                                clearTimeout(searchTimeout);
                                performRAGSearch(query);
                            }
                        }
                    });
                }
            } else {
                document.getElementById('mobileSearchInput')?.focus();
            }
        });

        searchClose?.addEventListener('click', collapseSearch);

        // Keyboard shortcut: / to open search
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                expandSearch();
            }
            // Escape to close
            if (e.key === 'Escape') {
                collapseSearch();
                searchResultsModal?.classList.add('hidden');
            }
        });

        // Clear results when input is emptied (no auto-search on typing)
        ragSearchInput?.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            clearTimeout(searchTimeout);

            if (query.length < 2) {
                searchResultsModal?.classList.add('hidden');
            }
        });

        // Enter to search immediately
        ragSearchInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const query = ragSearchInput.value.trim();
                if (query.length >= 2) {
                    clearTimeout(searchTimeout);
                    performRAGSearch(query);
                }
            }
        });

        // Close modal
        closeSearchResults?.addEventListener('click', () => {
            searchResultsModal?.classList.add('hidden');
        });

        // Clear search results and reset
        clearSearch?.addEventListener('click', () => {
            searchResultsList.innerHTML = '';
            searchResultsQuery.textContent = '';
            clearConversation();
            searchResultsModal?.classList.add('hidden');
            // Clear the search input too
            const heroSearchInput = document.querySelector('input[placeholder*="Search"]');
            if (heroSearchInput) heroSearchInput.value = '';
        });

        // Model selector change - rerun query with new model
        // Model selector change - just note the selection for next query
        // In chat mode, we don't re-run previous queries when model changes
        modelSelector?.addEventListener('change', () => {
            console.log('Model changed to:', modelSelector.value);
        });

        // Close modal on click outside
        searchResultsModal?.addEventListener('click', (e) => {
            if (e.target === searchResultsModal) {
                searchResultsModal.classList.add('hidden');
            }
        });

        // Tab elements
        const tabSearch = document.getElementById('tabSearch');
        const tabAsk = document.getElementById('tabAsk');
        const askResultsPanel = document.getElementById('askResultsPanel');
        const askSources = document.getElementById('askSources');
        const chatMessages = document.getElementById('chatMessages');
        const clearChatBtn = document.getElementById('clearChat');
        const loadingText = document.getElementById('loadingText');
        const footerRight = document.getElementById('footerRight');

        // Current active tab
        let activeTab = 'search';

        // Conversation state management
        let conversationHistory = [];  // [{role: 'user'|'assistant', content: string}]
        let conversationTopic = null;  // The original query that started this conversation
        let lastSearchContext = null;  // Cache last retrieved context for sources display

        // localStorage with 14-day expiry
        function loadConversation() {
            try {
                const saved = localStorage.getItem('neo_chat');
                if (saved) {
                    const {messages, topic, timestamp} = JSON.parse(saved);
                    const fourteenDays = 14 * 24 * 60 * 60 * 1000;
                    if (Date.now() - timestamp < fourteenDays) {
                        conversationTopic = topic || null;
                        return messages;
                    }
                    // Expired, clear it
                    localStorage.removeItem('neo_chat');
                }
            } catch (e) {
                console.warn('Failed to load conversation:', e);
            }
            return [];
        }

        function saveConversation() {
            try {
                localStorage.setItem('neo_chat', JSON.stringify({
                    messages: conversationHistory,
                    topic: conversationTopic,
                    timestamp: Date.now()
                }));
            } catch (e) {
                console.warn('Failed to save conversation:', e);
            }
        }

        // Smart follow-up detection
        function isFollowUp(query) {
            const q = query.toLowerCase().trim();
            // No history = not a follow-up
            if (conversationHistory.length === 0) return false;

            // Pronouns and references to previous context
            const followUpPatterns = [
                /^(tell me more|more about|expand on|elaborate)/i,
                /^(what about|how about|and what|and how)/i,
                /\b(it|that|this|those|these|them)\b/,
                /\b(the same|mentioned|above|previous)\b/,
                /^(why|how come|can you explain)/i,
                /^(also|additionally|furthermore)/i,
            ];

            // Short queries are likely follow-ups, but only after at least one full exchange
            // (need both a user message and assistant response in history)
            if (conversationHistory.length >= 2 && q.split(' ').length <= 4) {
                return true;
            }

            return followUpPatterns.some(p => p.test(q));
        }

        // Check if new query is related to existing conversation topic
        function isSameTopic(newQuery) {
            if (!conversationTopic) return false;

            const normalize = (str) => str.toLowerCase().replace(/[^a-z0-9\s]/g, '').split(/\s+/).filter(w => w.length > 2);
            const topicWords = new Set(normalize(conversationTopic));
            const queryWords = normalize(newQuery);

            // Check for significant word overlap
            const overlap = queryWords.filter(w => topicWords.has(w)).length;
            const overlapRatio = overlap / Math.max(queryWords.length, 1);

            // Consider same topic if >30% word overlap or any key terms match
            return overlapRatio > 0.3 || overlap >= 2;
        }

        // Clear conversation and reset UI
        function clearConversation() {
            conversationHistory = [];
            conversationTopic = null;
            lastSearchContext = null;
            localStorage.removeItem('neo_chat');
            if (chatMessages) {
                chatMessages.innerHTML = `
                    <div id="chatWelcome" class="flex flex-col items-center justify-center h-full text-center">
                        <img src="static/kdt-logo.png" class="w-12 h-12 mb-3 opacity-60">
                        <h3 class="text-lg font-semibold text-dark-700 dark:text-dark-300 mb-2">KdT Neo</h3>
                        <p class="text-sm text-dark-400 max-w-xs">Ask Neo anything about KdT's knowledge base</p>
                    </div>
                `;
            }
            if (askSources) {
                askSources.innerHTML = '';
                askSources.classList.add('hidden');
            }
        }

        // Render a chat message bubble
        function renderChatMessage(role, content, isTyping = false) {
            // Hide welcome message when there are messages (use fresh lookup in case element was recreated)
            const welcomeEl = document.getElementById('chatWelcome');
            if (welcomeEl) welcomeEl.classList.add('hidden');

            const bubble = document.createElement('div');

            if (role === 'user') {
                bubble.className = 'chat-bubble-user px-4 py-3';
                bubble.innerHTML = `<p class="text-sm">${escapeHtml(content)}</p>`;
            } else {
                bubble.className = 'chat-bubble-neo px-4 py-3 text-dark-800 dark:text-dark-200';
                if (isTyping) {
                    bubble.id = 'typingIndicator';
                    bubble.classList.add('thinking');
                    const thinkingMessages = [
                        "Searching the knowledge base...",
                        "Analyzing patents and grants...",
                        "Connecting the dots...",
                        "Reviewing the literature...",
                        "Synthesizing insights...",
                        "Almost there...",
                    ];
                    const randomMsg = thinkingMessages[Math.floor(Math.random() * thinkingMessages.length)];
                    bubble.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="static/kdt-logo.png" class="w-6 h-6 neo-thinking-logo" alt="">
                            <div>
                                <span class="text-sm neo-thinking-text">${randomMsg}</span>
                                <div class="typing-indicator flex items-center gap-1 mt-1"><span></span><span></span><span></span></div>
                            </div>
                        </div>
                    `;
                } else {
                    bubble.innerHTML = `<div class="text-sm leading-relaxed">${formatMarkdown(content)}</div>`;
                }
            }

            chatMessages?.appendChild(bubble);
            // Auto-scroll to bottom
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            return bubble;
        }

        // Restore conversation on load
        function restoreConversation() {
            conversationHistory = loadConversation();
            if (conversationHistory.length > 0 && chatMessages) {
                // Hide welcome, render all messages
                const welcomeEl = document.getElementById('chatWelcome');
                if (welcomeEl) welcomeEl.classList.add('hidden');
                conversationHistory.forEach(msg => {
                    renderChatMessage(msg.role, msg.content);
                });
            }
        }

        // Clear chat handler
        clearChatBtn?.addEventListener('click', () => {
            // Only confirm if there's actually a conversation to clear
            if (conversationHistory.length === 0) return;
            if (confirm('Clear conversation history?')) {
                clearConversation();
            }
        });

        // Initialize conversation on page load
        restoreConversation();

        // Chat input form handler
        const chatInputForm = document.getElementById('chatInputForm');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');

        async function submitChatMessage() {
            const message = chatInput?.value?.trim();
            if (!message || chatSendBtn?.disabled) return;

            // Clear input and disable while processing
            chatInput.value = '';
            chatSendBtn.disabled = true;

            // Update the query display
            const queryDisplay = document.getElementById('searchResultsQuery');
            if (queryDisplay) queryDisplay.textContent = message;

            // Run the ask
            await performAsk(message);

            // Re-enable input
            chatSendBtn.disabled = false;
            chatInput?.focus();
        }

        chatInputForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            await submitChatMessage();
        });

        // Also handle Enter key explicitly
        chatInput?.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                await submitChatMessage();
            }
        });

        // Tab switching
        function setActiveTab(tab) {
            activeTab = tab;
            if (tab === 'search') {
                tabSearch?.classList.add('border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400');
                tabSearch?.classList.remove('border-transparent', 'text-dark-500');
                tabAsk?.classList.remove('border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400');
                tabAsk?.classList.add('border-transparent', 'text-dark-500');
                searchResultsList?.classList.remove('hidden');
                askResultsPanel?.classList.add('hidden');
                if (footerRight) footerRight.innerHTML = 'Press <kbd class="px-1.5 py-0.5 bg-dark-200 dark:bg-dark-700 rounded">/</kbd> to search';
            } else {
                tabAsk?.classList.add('border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400');
                tabAsk?.classList.remove('border-transparent', 'text-dark-500');
                tabSearch?.classList.remove('border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400');
                tabSearch?.classList.add('border-transparent', 'text-dark-500');
                askResultsPanel?.classList.remove('hidden');
                searchResultsList?.classList.add('hidden');
                if (footerRight) footerRight.innerHTML = 'Powered by <span class="text-indigo-500">Claude</span>';
            }
        }

        tabSearch?.addEventListener('click', () => setActiveTab('search'));
        tabAsk?.addEventListener('click', () => {
            setActiveTab('ask');
            // Focus the chat input
            chatInput?.focus();
            // If there's a query and no conversation yet, run it through Ask AI
            const currentQuery = document.getElementById('searchResultsQuery')?.textContent?.trim();
            if (currentQuery && currentQuery.length > 0 && conversationHistory.length === 0) {
                performAsk(currentQuery);
            }
        });

        // Detect if query is a question
        function isQuestion(query) {
            const q = query.toLowerCase().trim();
            // Starts with question words
            if (/^(what|who|where|when|why|how|which|can|could|would|should|is|are|do|does|did|will|has|have|tell me|explain|describe|list|show me|find me)/i.test(q)) {
                return true;
            }
            // Ends with question mark
            if (q.endsWith('?')) {
                return true;
            }
            return false;
        }

        // Perform RAG search
        async function performRAGSearch(query) {
            console.log('performRAGSearch called with:', query);

            if (!searchResultsModal || !searchResultsList) {
                console.error('Modal elements not found');
                return;
            }

            // Smart topic detection: clear conversation if different topic
            if (conversationHistory.length > 0 && !isSameTopic(query)) {
                console.log('Different topic detected, clearing conversation');
                clearConversation();
            }

            // Auto-detect question and switch tabs
            const queryIsQuestion = isQuestion(query);
            console.log('Is question:', queryIsQuestion);

            // Show modal and loading state
            searchResultsModal.classList.remove('hidden');
            searchLoading?.classList.remove('hidden');
            searchResultsList.innerHTML = '';
            searchResultsQuery.textContent = query;

            if (queryIsQuestion) {
                setActiveTab('ask');
                if (loadingText) loadingText.textContent = 'Thinking...';
                // Set topic if starting fresh
                if (!conversationTopic) {
                    conversationTopic = query;
                }
                await performAsk(query);
            } else {
                setActiveTab('search');
                if (loadingText) loadingText.textContent = 'Searching across all tools...';
                await performSearch(query);
            }
        }

        // Perform search only (no AI)
        async function performSearch(query) {
            console.log('performSearch called with:', query);
            try {
                const url = `/api/rag-search?q=${encodeURIComponent(query)}&n_results=15`;
                console.log('Fetching:', url);
                const response = await fetch(url);
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Search data:', data);

                searchLoading?.classList.add('hidden');

                if (data.error) {
                    searchResultsList.innerHTML = `
                        <div class="text-center py-8 text-dark-500">
                            <p class="font-medium">Search unavailable</p>
                            <p class="text-sm mt-1">${data.detail || data.error}</p>
                        </div>
                    `;
                    return;
                }

                if (!data.results || data.results.length === 0) {
                    searchResultsList.innerHTML = `
                        <div class="text-center py-8 text-dark-500">
                            <p>No results found for "${escapeHtml(query)}"</p>
                        </div>
                    `;
                    return;
                }

                // Group results by source
                const grouped = {};
                data.results.forEach(r => {
                    if (!grouped[r.source]) grouped[r.source] = [];
                    grouped[r.source].push(r);
                });

                // Render results
                let html = '';
                for (const [source, results] of Object.entries(grouped)) {
                    html += `<div class="mb-4">
                        <h4 class="text-xs font-semibold uppercase tracking-wider text-dark-400 mb-2 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full ${sourceColors[source] || 'bg-gray-500'}"></span>
                            ${sourceLabels[source] || source}s (${results.length})
                        </h4>
                        <div class="space-y-2">`;

                    results.forEach(r => {
                        const score = Math.round(r.score * 100);
                        html += `
                            <a href="${r.url}" target="_blank"
                               class="block p-3 rounded-lg bg-dark-100 dark:bg-dark-800 hover:bg-dark-200 dark:hover:bg-dark-700 transition-colors">
                                <div class="flex items-start justify-between gap-2">
                                    <h5 class="font-medium text-sm text-dark-800 dark:text-dark-200 line-clamp-2">${escapeHtml(r.title)}</h5>
                                    <span class="text-xs px-1.5 py-0.5 rounded ${score > 70 ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' : 'bg-dark-200 text-dark-500 dark:bg-dark-700 dark:text-dark-400'}">${score}%</span>
                                </div>
                                <p class="text-xs text-dark-500 dark:text-dark-400 mt-1 line-clamp-2">${escapeHtml(r.snippet)}</p>
                            </a>
                        `;
                    });

                    html += '</div></div>';
                }

                searchResultsList.innerHTML = html;

            } catch (error) {
                console.error('Search error:', error);
                searchLoading?.classList.add('hidden');
                searchResultsList.innerHTML = `
                    <div class="text-center py-8 text-dark-500">
                        <p class="font-medium">Search failed</p>
                        <p class="text-sm mt-1">Please try again</p>
                    </div>
                `;
            }
        }

        // Perform AI Q&A with chat mode
        async function performAsk(question, model = null) {
            const selectedModel = model || modelSelector?.value || 'claude-3-5-haiku-20241022';
            console.log('performAsk called with:', question, 'model:', selectedModel);

            // Hide central loading spinner - we use typing indicator instead
            searchLoading?.classList.add('hidden');

            // Determine if this is a follow-up question BEFORE adding to history
            const skipSearch = isFollowUp(question);
            console.log('Is follow-up (skip search):', skipSearch);

            // Render user message as chat bubble
            renderChatMessage('user', question);

            // Add to conversation history
            conversationHistory.push({ role: 'user', content: question });

            // Show typing indicator
            renderChatMessage('assistant', '', true);

            try {
                console.log('Fetching /api/rag-ask...');
                const response = await fetch('/api/rag-ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question,
                        n_context: 8,
                        model: selectedModel,
                        messages: conversationHistory.slice(0, -1), // Exclude current question
                        skip_search: skipSearch
                    })
                });
                console.log('Response status:', response.status);

                const data = await response.json();
                console.log('Ask data:', data);

                searchLoading?.classList.add('hidden');

                // Remove typing indicator
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();

                if (data.error) {
                    renderChatMessage('assistant', `Error: ${data.detail || data.error}`);
                    return;
                }

                // Render assistant response as chat bubble
                renderChatMessage('assistant', data.answer);

                // Add to conversation history and save
                conversationHistory.push({ role: 'assistant', content: data.answer });
                saveConversation();

                // Render sources (only if we searched)
                if (!skipSearch && data.sources && data.sources.length > 0) {
                    lastSearchContext = data.sources;
                    let sourcesHtml = `
                        <p class="text-xs font-semibold uppercase tracking-wider text-dark-400 mb-2">
                            Based on ${data.context_count} documents
                        </p>
                        <div class="flex flex-wrap gap-2">
                    `;

                    data.sources.forEach(s => {
                        const sourceColor = sourceColors[s.source] || 'bg-gray-500';
                        if (s.url) {
                            sourcesHtml += `
                                <a href="${s.url}" target="_blank"
                                   class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full bg-dark-100 dark:bg-dark-800 hover:bg-dark-200 dark:hover:bg-dark-700 transition-colors text-xs">
                                    <span class="w-1.5 h-1.5 rounded-full ${sourceColor}"></span>
                                    <span class="text-dark-600 dark:text-dark-300">${escapeHtml(s.title?.substring(0, 40))}${s.title?.length > 40 ? '...' : ''}</span>
                                </a>
                            `;
                        } else {
                            sourcesHtml += `
                                <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full bg-dark-100 dark:bg-dark-800 text-xs">
                                    <span class="w-1.5 h-1.5 rounded-full ${sourceColor}"></span>
                                    <span class="text-dark-600 dark:text-dark-300">${escapeHtml(s.title?.substring(0, 40))}${s.title?.length > 40 ? '...' : ''}</span>
                                </span>
                            `;
                        }
                    });

                    sourcesHtml += '</div>';
                    if (askSources) {
                        askSources.innerHTML = sourcesHtml;
                        askSources.classList.remove('hidden');
                    }
                }

            } catch (error) {
                console.error('Ask error:', error);
                searchLoading?.classList.add('hidden');

                // Remove typing indicator
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();

                renderChatMessage('assistant', 'Sorry, something went wrong. Please try again.');
            }
        }

        // Simple markdown formatter
        function formatMarkdown(text) {
            if (!text) return '';
            return text
                // Bold
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                // Numbered lists
                .replace(/^\d+\.\s+(.+)$/gm, '<li class="ml-4 list-decimal">$1</li>')
                // Bullet lists
                .replace(/^[-*]\s+(.+)$/gm, '<li class="ml-4 list-disc">$1</li>')
                // Line breaks
                .replace(/\n\n/g, '</p><p class="mt-3">')
                .replace(/\n/g, '<br>')
                // Wrap in paragraph
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
    </script>

    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "c1d2e98e1eac477298229b99d0ef5935"}'></script>
</body>
</html>
